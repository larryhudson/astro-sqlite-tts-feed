---
import { getArticle, updateArticle } from "../../../utils/db";
import { extractArticle } from "../../../utils/extract-article";
import { getAudioBufferForText } from "../../../utils/azure-tts";
import md5 from "js-md5";
import fs from "fs/promises";
import path from "path";

const article = getArticle(Astro.params.id);

if (Astro.request.method === "POST") {
  const articleContent = await extractArticle(article.url);

  const articleAudio = await getAudioBufferForText(articleContent);
  const articleHash = md5(articleContent);
  const articlePath = path.join("public", "articles", `${articleHash}.mp3`);
  const mp3Url = `/articles/${articleHash}.mp3`;
  await fs.writeFile(articlePath, articleAudio);

  updateArticle(Astro.params.id, article.title, article.url, mp3Url);
  return Astro.redirect("/articles");
}
---
